/*!
 * Beebotte client JavaScript library
 * Version 0.6.0
 * http://beebotte.com
 * Report issues to https://github.com/beebotte/bbt_node/issues
 * Contact email contact@beebotte.com
 *
 * Copyright 2017, Beebotte Corporation
 * MIT licence
 */

/*********** DEPENDENCIES HERE ***************/

/*
 A JavaScript implementation of the SHA family of hashes, as
 defined in FIPS PUB 180-2 as well as the corresponding HMAC implementation
 as defined in FIPS PUB 198a

 Copyright Brian Turek 2008-2013
 Distributed under the BSD License
 See http://caligatio.github.com/jsSHA/ for more information

 Several functions taken from Paul Johnston
*/
(function(a){function d(a,d,u){var z=0,A=[0],v="",k=null,v=u||"UTF8";if("UTF8"!==v&&"UTF16"!==v)throw"encoding must be UTF8 or UTF16";if("HEX"===d){if(0!==a.length%2)throw"srcString of HEX type must be in byte increments";k=e(a);z=k.binLen;A=k.value}else if("ASCII"===d||"TEXT"===d)k=b(a,v),z=k.binLen,A=k.value;else if("B64"===d)k=f(a),z=k.binLen,A=k.value;else throw"inputFormat must be HEX, TEXT, ASCII, or B64";this.getHash=function(a,b,d,e){var f=null,t=A.slice(),u=z,v;3===arguments.length?"number"!==
typeof d&&(e=d,d=1):2===arguments.length&&(d=1);if(d!==parseInt(d,10)||1>d)throw"numRounds must a integer >= 1";switch(b){case "HEX":f=g;break;case "B64":f=h;break;default:throw"format must be HEX or B64";}if("SHA-1"===a)for(v=0;v<d;v++)t=w(t,u),u=160;else throw"Chosen SHA variant is not supported";return f(t,n(e))};this.getHMAC=function(a,d,t,u,E){var k,m,r,l,p=[],s=[];switch(u){case "HEX":u=g;break;case "B64":u=h;break;default:throw"outputFormat must be HEX or B64";}if("SHA-1"===t)m=64,l=160;else throw"Chosen SHA variant is not supported";
if("HEX"===d)k=e(a),r=k.binLen,k=k.value;else if("ASCII"===d||"TEXT"===d)k=b(a,v),r=k.binLen,k=k.value;else if("B64"===d)k=f(a),r=k.binLen,k=k.value;else throw"inputFormat must be HEX, TEXT, ASCII, or B64";a=8*m;d=m/4-1;if(m<r/8){if("SHA-1"===t)k=w(k,r);else throw"Unexpected error in HMAC implementation";k[d]&=4294967040}else m>r/8&&(k[d]&=4294967040);for(m=0;m<=d;m+=1)p[m]=k[m]^909522486,s[m]=k[m]^1549556828;if("SHA-1"===t)t=w(s.concat(w(p.concat(A),a+z)),a+l);else throw"Unexpected error in HMAC implementation";
return u(t,n(E))}}function b(a,b){var d=[],e,f=[],g=0,h;if("UTF8"===b)for(h=0;h<a.length;h+=1)for(e=a.charCodeAt(h),f=[],2048<e?(f[0]=224|(e&61440)>>>12,f[1]=128|(e&4032)>>>6,f[2]=128|e&63):128<e?(f[0]=192|(e&1984)>>>6,f[1]=128|e&63):f[0]=e,e=0;e<f.length;e+=1)d[g>>>2]|=f[e]<<24-g%4*8,g+=1;else if("UTF16"===b)for(h=0;h<a.length;h+=1)d[g>>>2]|=a.charCodeAt(h)<<16-g%4*8,g+=2;return{value:d,binLen:8*g}}function e(a){var b=[],d=a.length,e,f;if(0!==d%2)throw"String of HEX type must be in byte increments";
for(e=0;e<d;e+=2){f=parseInt(a.substr(e,2),16);if(isNaN(f))throw"String of HEX type contains invalid characters";b[e>>>3]|=f<<24-e%8*4}return{value:b,binLen:4*d}}function f(a){var b=[],d=0,e,f,g,h,p;if(-1===a.search(/^[a-zA-Z0-9=+\/]+$/))throw"Invalid character in base-64 string";e=a.indexOf("=");a=a.replace(/\=/g,"");if(-1!==e&&e<a.length)throw"Invalid '=' found in base-64 string";for(f=0;f<a.length;f+=4){p=a.substr(f,4);for(g=h=0;g<p.length;g+=1)e="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/".indexOf(p[g]),
h|=e<<18-6*g;for(g=0;g<p.length-1;g+=1)b[d>>2]|=(h>>>16-8*g&255)<<24-d%4*8,d+=1}return{value:b,binLen:8*d}}function g(a,b){var d="",e=4*a.length,f,g;for(f=0;f<e;f+=1)g=a[f>>>2]>>>8*(3-f%4),d+="0123456789abcdef".charAt(g>>>4&15)+"0123456789abcdef".charAt(g&15);return b.outputUpper?d.toUpperCase():d}function h(a,b){var d="",e=4*a.length,f,g,h;for(f=0;f<e;f+=3)for(h=(a[f>>>2]>>>8*(3-f%4)&255)<<16|(a[f+1>>>2]>>>8*(3-(f+1)%4)&255)<<8|a[f+2>>>2]>>>8*(3-(f+2)%4)&255,g=0;4>g;g+=1)d=8*f+6*g<=32*a.length?d+
"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/".charAt(h>>>6*(3-g)&63):d+b.b64Pad;return d}function n(a){var b={outputUpper:!1,b64Pad:"="};try{a.hasOwnProperty("outputUpper")&&(b.outputUpper=a.outputUpper),a.hasOwnProperty("b64Pad")&&(b.b64Pad=a.b64Pad)}catch(d){}if("boolean"!==typeof b.outputUpper)throw"Invalid outputUpper formatting option";if("string"!==typeof b.b64Pad)throw"Invalid b64Pad formatting option";return b}function p(a,b){return a<<b|a>>>32-b}function y(a,b,d){return a^
b^d}function s(a,b,d){return a&b^~a&d}function H(a,b,d){return a&b^a&d^b&d}function I(a,b){var d=(a&65535)+(b&65535);return((a>>>16)+(b>>>16)+(d>>>16)&65535)<<16|d&65535}function J(a,b,d,e,f){var g=(a&65535)+(b&65535)+(d&65535)+(e&65535)+(f&65535);return((a>>>16)+(b>>>16)+(d>>>16)+(e>>>16)+(f>>>16)+(g>>>16)&65535)<<16|g&65535}function w(a,b){var d=[],e,f,g,h,n,w,F=s,C=y,G=H,x=p,m=I,r,l,B=J,D,q=[1732584193,4023233417,2562383102,271733878,3285377520];a[b>>>5]|=128<<24-b%32;a[(b+65>>>9<<4)+15]=b;D=a.length;
for(r=0;r<D;r+=16){e=q[0];f=q[1];g=q[2];h=q[3];n=q[4];for(l=0;80>l;l+=1)d[l]=16>l?a[l+r]:x(d[l-3]^d[l-8]^d[l-14]^d[l-16],1),w=20>l?B(x(e,5),F(f,g,h),n,1518500249,d[l]):40>l?B(x(e,5),C(f,g,h),n,1859775393,d[l]):60>l?B(x(e,5),G(f,g,h),n,2400959708,d[l]):B(x(e,5),C(f,g,h),n,3395469782,d[l]),n=h,h=g,g=x(f,30),f=e,e=w;q[0]=m(e,q[0]);q[1]=m(f,q[1]);q[2]=m(g,q[2]);q[3]=m(h,q[3]);q[4]=m(n,q[4])}return q}"function"===typeof define&&typeof define.amd?define(function(){return d}):"undefined"!==typeof exports?
"undefined"!==typeof module&&module.exports?module.exports=exports=d:exports=d:a.jsSHA=d})(this);

/*
 * A JavaScript implementation of the RSA Data Security, Inc. MD5 Message
 * Digest Algorithm, as defined in RFC 1321.
 * Version 2.2 Copyright (C) Paul Johnston 1999 - 2009
 * Other contributors: Greg Holt, Andrew Kepert, Ydnar, Lostinet
 * Distributed under the BSD License
 * See http://pajhome.org.uk/crypt/md5 for more info.
 */
var hexcase=0,b64pad="=";function hex_md5(a){return rstr2hex(rstr_md5(str2rstr_utf8(a)))}function b64_md5(a){return rstr2b64(rstr_md5(str2rstr_utf8(a)))}function any_md5(a,d){return rstr2any(rstr_md5(str2rstr_utf8(a)),d)}function hex_hmac_md5(a,d){return rstr2hex(rstr_hmac_md5(str2rstr_utf8(a),str2rstr_utf8(d)))}
function b64_hmac_md5(a,d){return rstr2b64(rstr_hmac_md5(str2rstr_utf8(a),str2rstr_utf8(d)))}function any_hmac_md5(a,d,b){return rstr2any(rstr_hmac_md5(str2rstr_utf8(a),str2rstr_utf8(d)),b)}function md5_vm_test(){return"900150983cd24fb0d6963f7d28e17f72"==hex_md5("abc").toLowerCase()}function rstr_md5(a){return binl2rstr(binl_md5(rstr2binl(a),8*a.length))}
function rstr_hmac_md5(a,d){var b=rstr2binl(a);16<b.length&&(b=binl_md5(b,8*a.length));for(var e=Array(16),f=Array(16),g=0;16>g;g++)e[g]=b[g]^909522486,f[g]=b[g]^1549556828;b=binl_md5(e.concat(rstr2binl(d)),512+8*d.length);return binl2rstr(binl_md5(f.concat(b),640))}function rstr2hex(a){for(var d=hexcase?"0123456789ABCDEF":"0123456789abcdef",b="",e,f=0;f<a.length;f++)e=a.charCodeAt(f),b+=d.charAt(e>>>4&15)+d.charAt(e&15);return b}
function rstr2b64(a){for(var d="",b=a.length,e=0;e<b;e+=3)for(var f=a.charCodeAt(e)<<16|(e+1<b?a.charCodeAt(e+1)<<8:0)|(e+2<b?a.charCodeAt(e+2):0),g=0;4>g;g++)d=8*e+6*g>8*a.length?d+b64pad:d+"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/".charAt(f>>>6*(3-g)&63);return d}
function rstr2any(a,d){var b=d.length,e,f,g,h,n,p=Array(Math.ceil(a.length/2));for(e=0;e<p.length;e++)p[e]=a.charCodeAt(2*e)<<8|a.charCodeAt(2*e+1);var y=Math.ceil(8*a.length/(Math.log(d.length)/Math.log(2))),s=Array(y);for(f=0;f<y;f++){n=[];for(e=h=0;e<p.length;e++)if(h=(h<<16)+p[e],g=Math.floor(h/b),h-=g*b,0<n.length||0<g)n[n.length]=g;s[f]=h;p=n}b="";for(e=s.length-1;0<=e;e--)b+=d.charAt(s[e]);return b}
function str2rstr_utf8(a){for(var d="",b=-1,e,f;++b<a.length;)e=a.charCodeAt(b),f=b+1<a.length?a.charCodeAt(b+1):0,55296<=e&&56319>=e&&56320<=f&&57343>=f&&(e=65536+((e&1023)<<10)+(f&1023),b++),127>=e?d+=String.fromCharCode(e):2047>=e?d+=String.fromCharCode(192|e>>>6&31,128|e&63):65535>=e?d+=String.fromCharCode(224|e>>>12&15,128|e>>>6&63,128|e&63):2097151>=e&&(d+=String.fromCharCode(240|e>>>18&7,128|e>>>12&63,128|e>>>6&63,128|e&63));return d}
function str2rstr_utf16le(a){for(var d="",b=0;b<a.length;b++)d+=String.fromCharCode(a.charCodeAt(b)&255,a.charCodeAt(b)>>>8&255);return d}function str2rstr_utf16be(a){for(var d="",b=0;b<a.length;b++)d+=String.fromCharCode(a.charCodeAt(b)>>>8&255,a.charCodeAt(b)&255);return d}function rstr2binl(a){for(var d=Array(a.length>>2),b=0;b<d.length;b++)d[b]=0;for(b=0;b<8*a.length;b+=8)d[b>>5]|=(a.charCodeAt(b/8)&255)<<b%32;return d}
function binl2rstr(a){for(var d="",b=0;b<32*a.length;b+=8)d+=String.fromCharCode(a[b>>5]>>>b%32&255);return d}
function binl_md5(a,d){a[d>>5]|=128<<d%32;a[(d+64>>>9<<4)+14]=d;for(var b=1732584193,e=-271733879,f=-1732584194,g=271733878,h=0;h<a.length;h+=16)var n=b,p=e,y=f,s=g,b=md5_ff(b,e,f,g,a[h+0],7,-680876936),g=md5_ff(g,b,e,f,a[h+1],12,-389564586),f=md5_ff(f,g,b,e,a[h+2],17,606105819),e=md5_ff(e,f,g,b,a[h+3],22,-1044525330),b=md5_ff(b,e,f,g,a[h+4],7,-176418897),g=md5_ff(g,b,e,f,a[h+5],12,1200080426),f=md5_ff(f,g,b,e,a[h+6],17,-1473231341),e=md5_ff(e,f,g,b,a[h+7],22,-45705983),b=md5_ff(b,e,f,g,a[h+8],7,
1770035416),g=md5_ff(g,b,e,f,a[h+9],12,-1958414417),f=md5_ff(f,g,b,e,a[h+10],17,-42063),e=md5_ff(e,f,g,b,a[h+11],22,-1990404162),b=md5_ff(b,e,f,g,a[h+12],7,1804603682),g=md5_ff(g,b,e,f,a[h+13],12,-40341101),f=md5_ff(f,g,b,e,a[h+14],17,-1502002290),e=md5_ff(e,f,g,b,a[h+15],22,1236535329),b=md5_gg(b,e,f,g,a[h+1],5,-165796510),g=md5_gg(g,b,e,f,a[h+6],9,-1069501632),f=md5_gg(f,g,b,e,a[h+11],14,643717713),e=md5_gg(e,f,g,b,a[h+0],20,-373897302),b=md5_gg(b,e,f,g,a[h+5],5,-701558691),g=md5_gg(g,b,e,f,a[h+
10],9,38016083),f=md5_gg(f,g,b,e,a[h+15],14,-660478335),e=md5_gg(e,f,g,b,a[h+4],20,-405537848),b=md5_gg(b,e,f,g,a[h+9],5,568446438),g=md5_gg(g,b,e,f,a[h+14],9,-1019803690),f=md5_gg(f,g,b,e,a[h+3],14,-187363961),e=md5_gg(e,f,g,b,a[h+8],20,1163531501),b=md5_gg(b,e,f,g,a[h+13],5,-1444681467),g=md5_gg(g,b,e,f,a[h+2],9,-51403784),f=md5_gg(f,g,b,e,a[h+7],14,1735328473),e=md5_gg(e,f,g,b,a[h+12],20,-1926607734),b=md5_hh(b,e,f,g,a[h+5],4,-378558),g=md5_hh(g,b,e,f,a[h+8],11,-2022574463),f=md5_hh(f,g,b,e,a[h+
11],16,1839030562),e=md5_hh(e,f,g,b,a[h+14],23,-35309556),b=md5_hh(b,e,f,g,a[h+1],4,-1530992060),g=md5_hh(g,b,e,f,a[h+4],11,1272893353),f=md5_hh(f,g,b,e,a[h+7],16,-155497632),e=md5_hh(e,f,g,b,a[h+10],23,-1094730640),b=md5_hh(b,e,f,g,a[h+13],4,681279174),g=md5_hh(g,b,e,f,a[h+0],11,-358537222),f=md5_hh(f,g,b,e,a[h+3],16,-722521979),e=md5_hh(e,f,g,b,a[h+6],23,76029189),b=md5_hh(b,e,f,g,a[h+9],4,-640364487),g=md5_hh(g,b,e,f,a[h+12],11,-421815835),f=md5_hh(f,g,b,e,a[h+15],16,530742520),e=md5_hh(e,f,g,
b,a[h+2],23,-995338651),b=md5_ii(b,e,f,g,a[h+0],6,-198630844),g=md5_ii(g,b,e,f,a[h+7],10,1126891415),f=md5_ii(f,g,b,e,a[h+14],15,-1416354905),e=md5_ii(e,f,g,b,a[h+5],21,-57434055),b=md5_ii(b,e,f,g,a[h+12],6,1700485571),g=md5_ii(g,b,e,f,a[h+3],10,-1894986606),f=md5_ii(f,g,b,e,a[h+10],15,-1051523),e=md5_ii(e,f,g,b,a[h+1],21,-2054922799),b=md5_ii(b,e,f,g,a[h+8],6,1873313359),g=md5_ii(g,b,e,f,a[h+15],10,-30611744),f=md5_ii(f,g,b,e,a[h+6],15,-1560198380),e=md5_ii(e,f,g,b,a[h+13],21,1309151649),b=md5_ii(b,
e,f,g,a[h+4],6,-145523070),g=md5_ii(g,b,e,f,a[h+11],10,-1120210379),f=md5_ii(f,g,b,e,a[h+2],15,718787259),e=md5_ii(e,f,g,b,a[h+9],21,-343485551),b=safe_add(b,n),e=safe_add(e,p),f=safe_add(f,y),g=safe_add(g,s);return[b,e,f,g]}function md5_cmn(a,d,b,e,f,g){return safe_add(bit_rol(safe_add(safe_add(d,a),safe_add(e,g)),f),b)}function md5_ff(a,d,b,e,f,g,h){return md5_cmn(d&b|~d&e,a,d,f,g,h)}function md5_gg(a,d,b,e,f,g,h){return md5_cmn(d&e|b&~e,a,d,f,g,h)}
function md5_hh(a,d,b,e,f,g,h){return md5_cmn(d^b^e,a,d,f,g,h)}function md5_ii(a,d,b,e,f,g,h){return md5_cmn(b^(d|~e),a,d,f,g,h)}function safe_add(a,d){var b=(a&65535)+(d&65535);return(a>>16)+(d>>16)+(b>>16)<<16|b&65535}function bit_rol(a,d){return a<<d|a>>>32-d};

/*********** DEPENDENCIES OVER ***************/

BBT=function(a,d){checkAppKey(a);this.key=a;d=d||{};this.initDefaults();this.updateParams(d);this.instanceID=Math.floor(1E9*Math.random());BBT.instances.push(this);this.connection=new BBT.Connection(this);this.connect()};BBT.VERSION="0.6.0";
BBT.PROTO=1;BBT.ws_host="ws.beebotte.com";BBT.api_host="api.beebotte.com";BBT.host="beebotte.com";BBT.port=80;BBT.sport=443;BBT.debug=!1;
BBT.types={BBT_Any:"any",BBT_Number:"number",BBT_String:"string",BBT_Boolean:"boolean",BBT_Object:"object",BBT_Function:"function",BBT_Array:"array",BBT_Alpha:"alphabetic",BBT_Alphanum:"alphanumeric",BBT_Decimal:"decimal",BBT_Rate:"rate",BBT_Percentage:"percentage",BBT_Email:"email",BBT_GPS:"gps",BBT_CPU:"cpu",BBT_Memory:"memory",BBT_Temp:"temperature",BBT_Humidity:"humidity",BBT_BodyTemp:"body temperature"};BBT.AttributeTypesLabels="any;number;string;boolean;object;function;array;alphabetic;alphanumeric;decimal;rate;percentage;email;gps;cpu;memory;temperature;humidity;body temperature".split(";");
BBT.instances=[];BBT.prototype.initDefaults=function(){this.ws_host=BBT.ws_host;this.api_host=BBT.api_host;this.host=BBT.host;this.port=BBT.port;this.sport=BBT.sport;this.ssl=!0;this.auth_endpoint=null;this.auth_method="get";this.cipher=null;this.userinfo={}};
BBT.prototype.updateParams=function(a){a.auth_endpoint&&(this.auth_endpoint=a.auth_endpoint);a.auth_method&&(this.auth_method=a.auth_method.toLowerCase());a.userinfo&&(this.userinfo=a.userinfo);a.username&&(this.userinfo.username=a.username);a.host&&(this.host=a.host);a.ws_host&&(this.ws_host=a.ws_host);a.api_host&&(this.api_host=a.api_host);a.port&&(this.port=a.port);a.sport&&(this.sport=a.sport);!1===a.ssl&&(this.ssl=a.ssl);a.cipher&&(this.cipher=a.cipher)};
BBT.prototype.getWsUrl=function(){return(!0===this.ssl?"https://":"http://")+this.ws_host+":"+(!0===this.ssl?this.sport:this.port)};BBT.prototype.getApiUrl=function(){return(!0===this.ssl?"https://":"http://")+this.api_host+":"+(!0===this.ssl?this.sport:this.port)};BBT.Connection=function(a){this.bbt=a;this.connection=null;this.channels=new BBT.Channels};BBT.Connection.prototype.onConnection=function(){for(c in this.channels.channels)this.channels.channels[c].do_subscribe()};
BBT.Connection.prototype.connect=function(){if(this.connection&&this.connection.connected)return this;var a=this,d="key="+this.bbt.key+"&username="+(a.bbt.userinfo.username||"");this.connection=io(a.bbt.getWsUrl(),{query:d});this.connection.on("connect",function(){a.onConnection()});this.connection.on("disconnect",function(){});this.connection.on("message",function(b){if(b.channel&&b.resource){var d=a.channels.getAny(b.channel,b.resource);d&&d.fct(b)}});this.connection.connect();return this};
BBT.Connection.prototype.disconnect=function(){this.connection.connected&&(this.connection.io.disconnect(),this.connection.removeAllListeners());return this};BBT.Connection.prototype.send_auth=function(a,d){return this.send("control","authenticate",{auth:a.auth,source:d})?this.authenticated=!0:this.authenticated=!1};BBT.Connection.prototype.subscribe=function(a,d){var b=this.channels.get(a.channel,a.resource);b?b.update(a,d):(b=new BBT.Channel(a,d,this.bbt),this.channels.add(b),b.do_subscribe())};
BBT.Connection.prototype.unsubscribe=function(a){if(a=this.channels.get(a.channel,a.resource))a.unsubscribe(),this.channels.remove(a);return!0};BBT.Connection.prototype.publish=function(a){var d=this.channels.getChannelWithPermission(a.channel,a.resource,!1,!0);return d&&d.hasWritePermission()?this.send("stream","emit",{channel:a.channel,resource:a.resource,data:a.data})?a.callback(null,{code:0}):a.callback({code:11,message:"Error while publishing message!"}):a.callback({code:11,message:"Permission error: cant't publish on the given resource!"})};
BBT.Connection.prototype.write=function(a){var d=this.channels.getChannelWithPermission(a.channel,a.resource,!1,!0);return d&&d.hasWritePermission()?this.send("stream","write",{channel:a.channel,resource:a.resource,data:a.data})?a.callback(null,{code:0}):a.callback({code:11,message:"Error while writing message!"}):a.callback({code:11,message:"Permission error: cant't write on the given resource!"})};
BBT.Connection.prototype.send=function(a,d,b){return this.connection?(this.connection.json.send({version:BBT.PROTO,channel:a,event:d,data:b}),!0):!1};BBT.Channels=function(){this.channels=[]};BBT.Channels.prototype.all=function(){return this.channels};BBT.Channels.prototype.add=function(a){this.channels[a.eid]=a};BBT.Channels.prototype.remove=function(a){delete this.channels[a.eid]};BBT.Channels.prototype.get=function(a,d){return this.channels[a+"."+d]?this.channels[a+"."+d]:null};
BBT.Channels.prototype.getAny=function(a,d){return this.channels[a+"."+d]?this.channels[a+"."+d]:this.channels[a+".*"]?this.channels[a+".*"]:null};BBT.Channels.prototype.getChannelWithPermission=function(a,d,b,e){if(d=this.channels[a+"."+d]){if(a=!0,b&&(a=d.hasReadPermission()),e&&(a=d.hasWritePermission()),a)return d}else if(d=this.channels[a+".*"])if(a=!0,b&&(a=d.hasReadPermission()),e&&(a=d.hasWritePermission()),a)return d;return null};
BBT.Channel=function(a,d,b){this.eid=a.channel+"."+a.resource;this.channel=a.channel;this.resource=a.resource;this.bbt=b;this.fct=d;this.subscribed=!1;this.write=a.write||!1;this.read=a.read||!1;this.readPermission=this.writePermission=!1;this.onError=a.onError;this.onSuccess=a.onSuccess};
BBT.Channel.prototype.update=function(a){a.read="undefined"===typeof a.read?!0:!0===a.read;a.write=!0===a.write;if(a.read!==this.read||a.write!==this.write)return this.subscribed=!1,a.read?this.setReadPermission():this.resetReadPermission(),a.write?this.setWritePermission():this.resetWritePermission(),this.do_subscribe()};BBT.Channel.prototype.authNeeded=function(){return!0===this.write||0===this.channel.indexOf("private-")||0===this.channel.indexOf("presence-")?!0:!1};
BBT.Channel.prototype.do_subscribe=function(){var a=this;if(a.bbt.connection.connection.connected){var d=this.bbt.connection,b={};b.channel=a.channel;b.resource=a.resource||"*";b.ttl="number"===typeof b.ttl?b.ttl:0;b.read=a.read;b.write=a.write;"undefined"!==typeof a.bbt.userinfo&&(b.userinfo=a.bbt.userinfo);if(this.authNeeded()){if(!a.bbt.auth_endpoint)return a.onError("Authentication error: Missing authentication endpoint!");if(d.connection&&d.connection.connected&&d.connection.io.engine.id)if(b.sid=
d.connection.io.engine.id,"get"===d.bbt.auth_method)$.get(d.bbt.auth_endpoint,b).success(function(e){if(!e.auth)return a.onError("Bad authentication reply");b.sig=e.auth;e.userid&&(b.userid=e.userid);return d.send("control","subscribe",b)?(a.subscribe(),a.onSuccess("Successfully subscribed to "+a.channel+"."+a.resource),!0):!1}).error(function(b,d,g){return a.onError("Unable to authenticate client")});else if("post"===d.bbt.auth_method)$.post(d.bbt.auth_endpoint,b).success(function(e){if(!e.auth)return a.onError("Bad authentication reply");
b.sig=e.auth;e.userid&&(b.userid=e.userid);return d.send("control","subscribe",b)?(a.subscribe(),a.onSuccess("Successfully subscribed to "+a.channel+"."+a.resource),!0):!1}).error(function(b,d,g){return a.onError("Unable to authenticate client")});else{if("fct"===d.bbt.auth_method){sig=d.bbt.auth_endpoint(b.sid,b.channel,b.resource,b.ttl,b.read,b.write);if(!sig)return a.onError("Unable to authenticate client");b.sig=sig.auth;sig.userid&&(b.userid=sig.userid);return d.send("control","subscribe",b)?
(a.subscribe(),a.onSuccess("Successfully subscribed to "+a.channel+"."+a.resource),!0):!1}return a.onError("Unsupported authentication method!")}else return a.onError("Connection error encountered")}else return d.send("control","subscribe",b)?(a.subscribe(),a.onSuccess("Successfully subscribed to "+a.channel+"."+a.resource),!0):!1}};BBT.Channel.prototype.setReadPermission=function(){this.read=this.readPermission=!0};
BBT.Channel.prototype.setWritePermission=function(){this.write=this.writePermission=!0};BBT.Channel.prototype.resetReadPermission=function(){this.read=this.readPermission=!1};BBT.Channel.prototype.resetWritePermission=function(){this.write=this.writePermission=!1};BBT.Channel.prototype.subscribe=function(){this.subscribed=!0;!0===this.read&&this.setReadPermission();!0===this.write&&this.setWritePermission()};
BBT.Channel.prototype.unsubscribe=function(){this.subscribed=!1;this.resetReadPermission();this.resetWritePermission();return this.bbt.connection.send("control","unsubscribe",{channel:this.channel,resource:this.resource})};BBT.Channel.prototype.hasWritePermission=function(){return this.writePermission};BBT.Channel.prototype.hasReadPermission=function(){return this.readPermission};
function checkAppKey(a){null!==a&&void 0!==a||BBT.warn("Warning: You must pass your key id when you instantiate BBT.")}BBT.warn=function(a){window.console&&(window.console.warn?window.console.warn(a):window.console.log&&window.console.log(a));BBT.log&&BBT.log(a)};BBT.error=function(a){if(BBT.debug)throw a;BBT.warn(a)};BBT.prototype.setUsername=function(a){this.userinfo.username=a};BBT.prototype.connect=function(){this.connection.connect()};BBT.prototype.disconnect=function(){this.connection.disconnect()};
BBT.prototype.publish=function(a,d){var b={};b.channel=a.channel;b.resource=a.resource;b.data=null!=a.data?a.data:d;b.callback=a.callback||function(){};return b.channel?b.resource?"string"!==typeof b.channel?BBT.error("Invalid format: channel must be a string"):"string"!==typeof b.resource?BBT.error("Invalid format: resource must be a string"):null===b.data||void 0===b.data?BBT.error("Data message not specified"):this.connection.publish(b):BBT.error("resource not specified"):BBT.error("channel not specified")};
BBT.prototype.write=function(a,d){var b={};b.channel=a.channel;b.resource=a.resource;b.data=null!=a.data?a.data:d;b.callback=a.callback||function(){};return b.channel?b.resource?null===b.data||void 0===b.data?BBT.error("Data message not specified"):"string"!==typeof b.channel?BBT.error("Invalid format: channel must be a string"):"string"!==typeof b.resource?BBT.error("Invalid format: resource must be a string"):this.connection.write(b):BBT.error("resource not specified"):BBT.error("channel not specified")};
BBT.prototype.subscribe=function(a,d){var b={},e=d||a.callback;b.channel=a.channel;b.resource=a.resource||"*";b.ttl="number"===typeof a.ttl?a.ttl:0;b.read="undefined"===typeof a.read?!0:!0===a.read;b.write=!0===a.write;b.onError=a.onError||BBT.warn;b.onSuccess=a.onSuccess||function(){};var f=b.onError;return b.channel?"string"!==typeof b.channel?f("Invalid format: channel must be a string"):"string"!==typeof b.resource?f("Invalid format: resource must be a string"):"number"!==typeof b.ttl?f("Invalid format: ttl must be a number"):
"boolean"!==typeof b.read?f("Invalid format: read element must be boolean"):"boolean"!==typeof b.write?f("Invalid format: write element must be boolean"):b.read&&!e?f("Callback not specified. The callback parameter is mandatory for read operations"):this.connection.subscribe(b,e):f("channel not specified")};
BBT.prototype.unsubscribe=function(a){var d={};d.channel=a.channel;d.resource=a.resource||"*";d.onError=a.onError||BBT.warn;d.onSuccess=a.onSuccess||function(){};return d.channel?"string"!==typeof d.channel?d.onError("Invalid format: channel must be a string"):"string"!==typeof d.resource?d.onError("Invalid format: resource must be a string"):this.connection.unsubscribe(d):d.onError("channel not specified")};
BBT.prototype.read=function(a,d){var b=a.limit||1;if(!a.owner)return BBT.error("Owner not specified");if(!a.channel)return BBT.error("channel not specified");if(!a.resource)return BBT.error("resource not specified");if("string"!==typeof a.owner)return BBT.error("Invalid format: owner must be a string");if("string"!==typeof a.channel)return BBT.error("Invalid format: channel must be a string");if("string"!==typeof a.resource)return BBT.error("Invalid format: resource must be a string");if("number"!==
typeof b)return BBT.error("Invalid format: limit must be a number");var e=a.callback||d;if(!e)return BBT.error("Callback function not specified");$.get(this.getApiUrl()+"/v1/public/data/read/"+a.owner+"/"+a.channel+"/"+a.resource,{limit:b}).success(function(a){e&&e(null,a)}).error(function(a,b,d){e&&e({code:11,message:"Error"},null)})};
BBT.Connector=function(a){this.protocol=this.hostname=this.port=this.secretKey=this.keyId=null;if(a.keyId&&a.secretKey)this.keyId=a.keyId,this.secretKey=a.secretKey;else throw Error("(BBT.Connector) Parameter Error: You must provide your API access key and secret key!");this.protocol=a.protocol||"https";if("http"!==this.protocol.toLowerCase()&&"https"!==this.protocol.toLowerCase())throw Error("Unsupported protocol "+this.protocol);this.hostname=a.hostname||"api.beebotte.com";"http"===this.protocol.toLowerCase()?
this.port=80:this.port=443;a.port&&(this.port=a.port);this.sign=function(a){a=(new jsSHA(a,"TEXT")).getHMAC(this.secretKey,"TEXT","SHA-1","B64");return this.keyId+":"+a};this.signRequest=function(a,b,e,f,g){a=a.toUpperCase();if(("POST"==a||"PUT"==a)&&""==b)throw Error("(BBT.Connector.signRequest) Content-MD5 header required for POST and PUT methods");return this.sign(a+"\n"+b+"\n"+e+"\n"+f+"\n"+g)};this.getUriToSign=function(a,b,e){return"POST"===a||"PUT"===a?b:b+(e?"?"+jQuery.param(e):"")};this.sendRequest=
function(a,b){var d=this;a.method=a.method.toUpperCase();(new Date).toUTCString();var f="";if("POST"===a.method||"PUT"===a.method)f=b64_md5(a.data);var g=function(a){};!0!==a.is_public&&(g=function(b){f&&b.setRequestHeader("Content-MD5",f);b.setRequestHeader("Authorization",d.signRequest(a.method,f,"application/json; charset=UTF-8","",d.getUriToSign(a.method,a.uri,a.data)));b.setRequestHeader("X-Bbt-Date",(new Date).toUTCString())});$.ajax({url:this.protocol+"://"+this.hostname+":"+this.port.toString()+
a.uri,type:a.method,dataType:"json",data:a.data,contentType:"application/json; charset=UTF-8",beforeSend:g,success:function(a){b(null,a)},error:function(a){b(a,a)}})}};
BBT.Connector.prototype.readPublicResource=function(a,d){var b={limit:a.limit||750};a.source&&(b.source=a.source);a["time-range"]&&(b["time-range"]=a["time-range"]);a["start-time"]&&(b["start-time"]=a["start-time"]);a["end-time"]&&(b["end-time"]=a["end-time"]);a.filter&&(b.filter=a.filter);a["sample-rate"]&&(b["sample-rate"]=a["sample-rate"]);options={uri:"/v1/public/data/read/"+a.owner+"/"+a.channel+"/"+a.resource,data:b,method:"GET",is_public:!0};return this.sendRequest(options,d)};
BBT.Connector.prototype.readResource=function(a,d){var b={limit:a.limit||750};a.source&&(b.source=a.source);a["time-range"]&&(b["time-range"]=a["time-range"]);a["start-time"]&&(b["start-time"]=a["start-time"]);a["end-time"]&&(b["end-time"]=a["end-time"]);a.filter&&(b.filter=a.filter);a["sample-rate"]&&(b["sample-rate"]=a["sample-rate"]);options={uri:"/v1/data/read/"+a.channel+"/"+a.resource,data:b,method:"GET",is_public:!1};return this.sendRequest(options,d)};
BBT.Connector.prototype.writeResource=function(a,d){var b={data:a.data};a.ts&&(b.ts=a.ts);b=JSON.stringify(b);options={uri:"/v1/data/write/"+a.channel+"/"+a.resource,data:b,method:"POST",is_public:!1};return this.sendRequest(options,d)};BBT.Connector.prototype.writeBulk=function(a,d){var b=JSON.stringify({records:a.records});options={uri:"/v1/data/write/"+a.channel,data:b,method:"POST",is_public:!1};return this.sendRequest(options,d)};
BBT.Connector.prototype.publish=function(a,d){var b={data:a.data};a.ts&&(b.ts=a.ts);a.source&&(b.source=a.source);b=JSON.stringify(b);options={uri:"/v1/data/publish/"+a.channel+"/"+a.resource+"?"+(a["private"]?"private=true":"private=false"),data:b,method:"POST",is_public:!1};return this.sendRequest(options,d)};
BBT.Connector.prototype.publishBulk=function(a,d){var b=JSON.stringify({records:a.records});options={uri:"/v1/data/publish/"+a.channel+"?"+(a["private"]?"private=true":"private=false"),data:b,method:"POST",is_public:!1};return this.sendRequest(options,d)};BBT.Connector.prototype.auth=function(a,d,b,e,f,g){return a&&d?{auth:this.sign(a+":"+d+"."+(b||"*")+":ttl="+("number"===typeof e?e:0)+":read="+("undefined"===typeof f?!0:!0===f)+":write="+(!0===g))}:null};
